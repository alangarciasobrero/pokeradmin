
<!-- Tournament Detail View (Handlebars) -->
{{!-- Contenedor principal de la vista de detalles de torneo --}}
<div class="tournament-detail-container">
    {{!-- Enlace para volver a la p√°gina anterior --}}
    <a class="back-link" href="javascript:history.back()">&#8592; Volver</a>

    <h1>
        <svg class="trophy-icon" viewBox="0 0 24 24" fill="none"><defs><radialGradient id="gold" cx="50%" cy="50%" r="80%"><stop offset="0%" stop-color="#fffde4"/><stop offset="100%" stop-color="#FFD600"/></radialGradient></defs><path d="M7 2a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h1v2.09A7.001 7.001 0 0 0 5 14a7 7 0 0 0 14 0 7.001 7.001 0 0 0-3-5.91V6h1a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1H7Zm1 2V4h8v1H8Zm4 16a5 5 0 0 1-5-5c0-2.21 1.44-4.08 3.5-4.77V6h3v2.23A5.002 5.002 0 0 1 17 13a5 5 0 0 1-5 5Z" fill="url(#gold)" stroke="#FFD600" stroke-width="1.2"/><circle cx="12" cy="19" r="1.2" fill="#FFD600"/></svg>
        {{tournament.tournament_name}}
    </h1>
    {{!-- Informaci√≥n detallada del torneo, cada campo con su icono --}}
    <div class="tournament-info">
    {{!-- Fecha del torneo --}}
    <p><span class="label"><svg class="icon" viewBox="0 0 24 24" fill="#3949ab"><path d="M19 4h-1V2h-2v2H8V2H6v2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2Zm0 16H5V9h14v11Zm0-13H5V6h14v1Z"/><rect x="7" y="11" width="10" height="2" rx="1" fill="#3949ab"/></svg> Fecha:</span> {{formatDateTime tournament.start_date}}</p>
    {{!-- Buy-in del torneo --}}
    <p><span class="label"><svg class="icon" viewBox="0 0 24 24" fill="#43a047"><circle cx="12" cy="12" r="10"/><text x="12" y="16" text-anchor="middle" font-size="11" fill="#fff" font-family="Arial" font-weight="bold">$</text></svg> Buy-in:</span> ${{tournament.buy_in}}</p>
    {{!-- Re-entry permitido --}}
    <p><span class="label"><svg class="icon" viewBox="0 0 24 24" fill="#1976d2"><rect x="4" y="4" width="16" height="16" rx="8"/><text x="12" y="16" text-anchor="middle" font-size="11" fill="#fff" font-family="Arial" font-weight="bold">R</text></svg> Re-entry:</span> {{tournament.re_entry}}</p>
    {{!-- Premio por knockout --}}
    <p><span class="label"><svg class="icon" viewBox="0 0 24 24" fill="#FFD600"><circle cx="12" cy="12" r="10"/><text x="12" y="16" text-anchor="middle" font-size="11" fill="#3949ab" font-family="Arial" font-weight="bold">K</text></svg> Premio Knockout:</span> ${{tournament.knockout_bounty}}</p>
    {{!-- Stack inicial --}}
    <p><span class="label"><svg class="icon" viewBox="0 0 24 24" fill="#8e24aa"><rect x="4" y="4" width="16" height="16" rx="4"/><text x="12" y="16" text-anchor="middle" font-size="11" fill="#fff" font-family="Arial" font-weight="bold">S</text></svg> Stack Inicial:</span> {{tournament.starting_stack}}</p>
    {{!-- Cuenta para ranking --}}
    <p><span class="label"><svg class="icon" viewBox="0 0 24 24" fill="#00bcd4"><circle cx="12" cy="12" r="10"/><text x="12" y="16" text-anchor="middle" font-size="11" fill="#fff" font-family="Arial" font-weight="bold">CR</text></svg> Cuenta para Ranking:</span> <span class="badge badge-{{tournament.count_to_ranking}}">{{#if tournament.count_to_ranking}}S√≠{{else}}No{{/if}}</span></p>
    {{!-- Doble puntaje --}}
    <p><span class="label"><svg class="icon" viewBox="0 0 24 24" fill="#ff7043"><rect x="4" y="4" width="16" height="16" rx="4"/><text x="12" y="16" text-anchor="middle" font-size="11" fill="#fff" font-family="Arial" font-weight="bold">DP</text></svg> Doble Puntaje:</span> <span class="badge badge-{{tournament.double_points}}">{{#if tournament.double_points}}S√≠{{else}}No{{/if}}</span></p>
    {{!-- Niveles de re-entry --}}
    <p><span class="label"><svg class="icon" viewBox="0 0 24 24" fill="#3949ab"><rect x="4" y="4" width="16" height="16" rx="4"/><text x="12" y="16" text-anchor="middle" font-size="11" fill="#fff" font-family="Arial" font-weight="bold">RE</text></svg> Niveles Re-entry:</span> {{tournament.blind_levels}} niveles</p>
    {{!-- Duraci√≥n de ciegas --}}
    <p><span class="label"><svg class="icon" viewBox="0 0 24 24" fill="#FF6F00"><circle cx="12" cy="12" r="10"/><text x="12" y="16" text-anchor="middle" font-size="11" fill="#fff" font-family="Arial" font-weight="bold">‚è±</text></svg> Duraci√≥n Ciega:</span> {{tournament.small_blind}} minutos</p>
    {{!-- Descuento por puntualidad --}}
    <p><span class="label"><svg class="icon" viewBox="0 0 24 24" fill="#FFD600"><rect x="4" y="4" width="16" height="16" rx="4"/><text x="12" y="16" text-anchor="middle" font-size="11" fill="#3949ab" font-family="Arial" font-weight="bold">PD</text></svg> Descuento Puntualidad:</span> ${{tournament.punctuality_discount}}</p>
    {{!-- Temporada --}}
    {{#if tournament.season}}
    <p><span class="label"><svg class="icon" viewBox="0 0 24 24" fill="#9c27b0"><polygon points="12,2 15,9 22,9 17,14 19,21 12,17 5,21 7,14 2,9 9,9"/></svg> Temporada:</span> <span class="badge badge-season">{{tournament.season.nombre}}</span></p>
    {{/if}}
    </div>

    {{#if isAdmin}}
    <div class="admin-actions">
                {{#if tournament.registration_open}}
                    <button id="openCloseRegistrationsBtn" class="btn btn-warning">üîí Cerrar Inscripciones y Ver Pozo</button>
                {{else}}
                    <form method="post" action="/admin/games/tournaments/{{tournament.id}}/open-registrations" style="display:inline">
                        <button type="submit" class="btn">Reabrir inscripciones</button>
                    </form>
                    <button id="openFinalizeModalBtn" class="btn btn-danger" style="margin-left:0.5rem">üèÅ Finalizar Torneo y Asignar Premios</button>
                {{/if}}
            </div>
    {{/if}}

            <!-- Modal for close registrations (preview only) -->
            <div id="registrationsModal" class="modal" style="display:none;">
                <div class="modal-content" style="max-width:700px;background:#1e1e1e;color:#fff">
                    <h2 style="margin-top:0;color:#ff9800">üîí Cerrar Inscripciones</h2>
                    <p style="color:#bbb;margin-top:0">Informaci√≥n del pozo y c√°lculos del torneo</p>
                    <div id="registrationsModalBody">Cargando...</div>
                    <div style="margin-top:1rem;padding:1rem;background:#2a2a2a;border-radius:6px;display:flex;gap:1rem;justify-content:flex-end">
                        <button id="cancelRegistrationsBtn" class="btn" style="background:#757575;color:white">Cancelar</button>
                        <button id="confirmCloseRegistrationsBtn" class="btn btn-primary" style="background:#f57c00;font-weight:bold">‚úì Cerrar Inscripciones</button>
                    </div>
                </div>
            </div>

            <!-- Modal for finalize tournament (with positions) -->
            <div id="finalizeModal" class="modal" style="display:none;">
                <div class="modal-content" style="max-width:900px;background:#1e1e1e;color:#fff">
                    <h2 style="margin-top:0;color:#64b5f6">üèÅ Finalizar Torneo - Asignar Posiciones y Premios</h2>
                    <p style="color:#bbb;margin-top:0">Asigna las posiciones finales de cada jugador y los premios correspondientes</p>
                    <div id="finalizeModalBody">Cargando...</div>
                    <div style="margin-top:1rem;padding:1rem;background:#2a2a2a;border-radius:6px;display:flex;gap:1rem;justify-content:flex-end">
                        <button id="cancelFinalizeBtn" class="btn" style="background:#757575;color:white">Cancelar</button>
                        <button id="confirmFinalizeBtn" class="btn btn-primary" style="background:#2e7d32;font-weight:bold">‚úì Confirmar y Finalizar Torneo</button>
                    </div>
                </div>
            </div>

                <style>
                .modal { 
                    position: fixed; 
                    inset: 0; 
                    background: rgba(0,0,0,0.85); 
                    display: none; /* Oculto por defecto */
                    align-items:center; 
                    justify-content:center; 
                    z-index: 1000;
                    padding: 1rem;
                }
                .modal-content { 
                    background: #1e1e1e; 
                    padding: 1.5rem; 
                    border-radius: 8px; 
                    max-width: 900px; 
                    width: 100%; 
                    color: #fff;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
                    max-height: 90vh;
                    overflow-y: auto;
                }
                .modal-content h2 {
                    border-bottom: 3px solid #1976d2;
                    padding-bottom: 0.5rem;
                }
                
                @media (max-width: 768px) {
                    .modal-content {
                        padding: 1rem;
                        max-width: 100%;
                    }
                }
                
                @media (max-width: 480px) {
                    .modal {
                        padding: 0.5rem;
                    }
                    
                    .modal-content {
                        padding: 0.75rem;
                        max-height: 95vh;
                    }
                    
                    .modal-content h2 {
                        font-size: 1.25rem;
                    }
                }
                
                @media (max-width: 375px) {
                    .modal-content {
                        padding: 0.5rem;
                    }
                    
                    .modal-content h2 {
                        font-size: 1.1rem;
                    }
                }
            </style>

                <script>
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('DOM loaded, initializing tournament modals...');
                    (function(){
                        // wrap preview-close wiring in an async IIFE to avoid top-level await
                        (async function() {
                            const tid = {{tournament.id}};
                            
                            // Registrations modal elements
                            const openCloseRegistrationsBtn = document.getElementById('openCloseRegistrationsBtn');
                            const registrationsModal = document.getElementById('registrationsModal');
                            const registrationsBody = registrationsModal ? registrationsModal.querySelector('#registrationsModalBody') : null;
                            const confirmCloseRegistrationsBtn = document.getElementById('confirmCloseRegistrationsBtn');
                            const cancelRegistrationsBtn = document.getElementById('cancelRegistrationsBtn');
                            
                            console.log('Tournament modal initialization:', {
                                tid,
                                openCloseRegistrationsBtn,
                                registrationsModal,
                                registrationsBody
                            });
                        
                        // Finalize modal elements
                        const openFinalizeBtn = document.getElementById('openFinalizeModalBtn');
                        const finalizeModal = document.getElementById('finalizeModal');
                        const finalizeBody = finalizeModal ? finalizeModal.querySelector('#finalizeModalBody') : null;
                        const confirmFinalizeBtn = document.getElementById('confirmFinalizeBtn');
                        const cancelFinalizeBtn = document.getElementById('cancelFinalizeBtn');

                        // Render preview for CLOSE REGISTRATIONS (no positions)
                        function renderRegistrationsPreview(j) {
                            try {
                                let html = '<div style="max-height:60vh;overflow-y:auto;padding:0.5rem">';
                                
                                // Summary section
                                html += '<div style="background:rgba(255,255,255,0.05);padding:1.5rem;border-radius:6px;margin-bottom:1rem;border:1px solid rgba(255,255,255,0.1)">';
                                html += `<h4 style="margin-top:0;color:#FFD700">üí∞ Resumen Financiero</h4>`;
                                html += `<p style="font-size:1.1rem;color:#fff"><strong>Pozo total:</strong> <span style="font-size:1.5rem;color:#4CAF50;font-weight:bold">$${Math.round(j.pot||0)}</span></p>`;
                                html += `<p style="color:#ddd"><strong>Total cajas:</strong> ${j.totalBoxes || 0}</p>`;
                                html += '<div style="background:rgba(255,215,0,0.1);padding:1rem;border-radius:4px;margin:1rem 0;border:1px solid rgba(255,215,0,0.2)">';
                                html += '<p style="margin:0;font-weight:bold;color:#FFD700">üíº Comisiones (Total 20%):</p>';
                                html += '<div style="margin-left:1rem;margin-top:0.5rem">';
                                html += `<p style="margin:0.25rem 0;color:#ddd">üè¢ Casa (18%): <span style="color:#4CAF50;font-weight:bold">$${Math.round(j.commissionHouse||0)}</span></p>`;
                                html += `<p style="margin:0.25rem 0;color:#ddd">üèÜ Ranking Temporada (1%): <span style="color:#4CAF50;font-weight:bold">$${Math.round(j.commissionSeason||0)}</span></p>`;
                                html += `<p style="margin:0.25rem 0;color:#ddd">‚≠ê Ranking Anual (1%): <span style="color:#4CAF50;font-weight:bold">$${Math.round(j.commissionAnnual||0)}</span></p>`;
                                html += `<p style="margin:0.5rem 0;padding-top:0.5rem;border-top:1px solid rgba(255,255,255,0.2);font-weight:bold;color:#FFD700">Total comisi√≥n: $${Math.round(j.commissionAmount||0)}</p>`;
                                html += '</div></div>';
                                html += `<p style="font-size:1.1rem;color:#fff"><strong>Pozo para premios:</strong> <span style="font-size:1.5rem;color:#64B5F6;font-weight:bold">$${Math.round(j.prizePool||0)}</span></p>`;
                                html += '</div>';
                                
                                // Ranking points info
                                html += '<div style="background:rgba(100,181,246,0.1);padding:1.5rem;border-radius:6px;margin-bottom:1rem;border:1px solid rgba(100,181,246,0.3)">';
                                html += `<h4 style="margin-top:0;color:#64B5F6">üèÜ Puntos de Ranking</h4>`;
                                html += `<p style="color:#fff"><strong>Total puntos a repartir:</strong> <span style="font-size:1.5rem;color:#FFD700;font-weight:bold">${j.boxPoints || 0} pts</span></p>`;
                                html += '<p style="color:#aaa;font-size:0.9rem">Se distribuir√°n entre los primeros 9 lugares al finalizar el torneo</p>';
                                html += '</div>';

                                // Tabla detallada de distribuci√≥n
                                html += '<details style="margin-top:1rem;background:rgba(255,255,255,0.03);padding:1rem;border-radius:6px;border:1px solid rgba(255,255,255,0.1);" open>';
                                html += '<summary style="cursor:pointer;font-weight:600;color:#FFD700;padding:0.5rem;margin-bottom:1rem;">üìä Ver distribuci√≥n detallada de premios y puntos</summary>';
                                html += '<div style="overflow-x:auto;">';
                                html += '<table style="width:100%;border-collapse:collapse;margin-top:1rem;">';
                                html += '<thead><tr style="background:rgba(255,255,255,0.05);">';
                                html += '<th style="padding:0.75rem;text-align:left;color:#FFD700;border-bottom:2px solid rgba(255,215,0,0.3);">Posici√≥n</th>';
                                html += '<th style="padding:0.75rem;text-align:right;color:#FFD700;border-bottom:2px solid rgba(255,215,0,0.3);">Premio ($)</th>';
                                html += '<th style="padding:0.75rem;text-align:right;color:#2196F3;border-bottom:2px solid rgba(33,150,243,0.3);">Puntos</th>';
                                html += '<th style="padding:0.75rem;text-align:center;color:#999;border-bottom:2px solid rgba(255,255,255,0.1);">% Premio</th>';
                                html += '<th style="padding:0.75rem;text-align:center;color:#999;border-bottom:2px solid rgba(255,255,255,0.1);">% Puntos</th>';
                                html += '</tr></thead><tbody>';

                                // Combinar prizes y points en una sola tabla
                                const maxPos = Math.max(
                                    (j.defaultPrizes || []).length,
                                    (j.rankingPointsDistribution || []).length
                                );

                                for (let i = 0; i < maxPos; i++) {
                                    const prize = (j.defaultPrizes || [])[i];
                                    const points = (j.rankingPointsDistribution || [])[i];
                                    
                                    if (prize && prize.amount > 0 || points && points.points > 0) {
                                        const pos = i + 1;
                                        const medal = pos === 1 ? 'ü•á' : pos === 2 ? 'ü•à' : pos === 3 ? 'ü•â' : `${pos}¬∫`;
                                        html += `<tr style="border-bottom:1px solid rgba(255,255,255,0.05);">`;
                                        html += `<td style="padding:0.75rem;color:#ddd;font-weight:600;">${medal}</td>`;
                                        html += `<td style="padding:0.75rem;text-align:right;color:#FFD700;font-weight:600;">$${prize ? Math.round(prize.amount) : '0'}</td>`;
                                        html += `<td style="padding:0.75rem;text-align:right;color:#2196F3;font-weight:600;">${points ? points.points : 0}</td>`;
                                        html += `<td style="padding:0.75rem;text-align:center;color:#999;font-size:0.9rem;">${prize ? prize.percentage : 0}%</td>`;
                                        html += `<td style="padding:0.75rem;text-align:center;color:#999;font-size:0.9rem;">${points ? points.percentage : 0}%</td>`;
                                        html += '</tr>';
                                    }
                                }

                                html += '</tbody></table></div></details>';

                                html += '</div>';
                                if (registrationsBody) registrationsBody.innerHTML = html;
                            } catch (e) {
                                console.error('Error rendering registrations preview:', e);
                                if (registrationsBody) registrationsBody.innerHTML = '<p>Error cargando informaci√≥n</p>';
                            }
                        }

                        // Render preview for FINALIZE TOURNAMENT (with positions)
                        function renderFinalizePreview(j) {
                            try {
                                let html = '<div style="max-height:70vh;overflow-y:auto;padding:0.5rem">';
                                
                                // Summary section
                                html += '<div style="background:rgba(255,255,255,0.05);padding:1rem;border-radius:6px;margin-bottom:1rem;border:1px solid rgba(255,255,255,0.1)">';
                                html += `<h4 style="margin-top:0;color:#FFD700">üí∞ Resumen Financiero</h4>`;
                                html += `<p style="color:#fff"><strong>Pozo total:</strong> <span id="modalPot" style="font-size:1.2rem;color:#4CAF50;font-weight:bold">$${Math.round(j.pot||0)}</span></p>`;
                                html += `<p style="color:#ddd"><strong>Total cajas:</strong> ${j.totalBoxes || 0}</p>`;
                                html += '<div style="background:rgba(255,215,0,0.1);padding:0.75rem;border-radius:4px;margin:0.5rem 0;border:1px solid rgba(255,215,0,0.2)">';
                                html += '<p style="margin:0;color:#FFD700"><strong>üíº Comisiones (Total 20%):</strong></p>';
                                html += '<div style="margin-left:1rem;margin-top:0.5rem">';
                                html += `<p style="margin:0.25rem 0;color:#ddd">üè¢ Casa: ${j.commissionHousePct || 18}% = <span id="commissionHouse" style="color:#4CAF50;font-weight:bold">$${Math.round(j.commissionHouse||0)}</span></p>`;
                                html += `<p style="margin:0.25rem 0;color:#ddd">üèÜ Ranking Temporada: ${j.commissionSeasonPct || 1}% = <span id="commissionSeason" style="color:#4CAF50;font-weight:bold">$${Math.round(j.commissionSeason||0)}</span></p>`;
                                html += `<p style="margin:0.25rem 0;color:#ddd">‚≠ê Ranking Anual: ${j.commissionAnnualPct || 1}% = <span id="commissionAnnual" style="color:#4CAF50;font-weight:bold">$${Math.round(j.commissionAnnual||0)}</span></p>`;
                                html += `<p style="margin:0.5rem 0;padding-top:0.5rem;border-top:1px solid rgba(255,255,255,0.2);color:#FFD700"><strong>Total comisi√≥n:</strong> <span id="commissionAmount">$${Math.round(j.commissionAmount||0)}</span></p>`;
                                html += '</div></div>';
                                html += `<p style="color:#fff"><strong>Pozo para premios:</strong> <span id="modalPrizePool" style="font-size:1.2rem;color:#64B5F6;font-weight:bold">$${Math.round(j.prizePool||0)}</span></p>`;
                                html += '</div>';

                                // Ranking points section
                                html += '<div style="background:rgba(100,181,246,0.1);padding:1rem;border-radius:6px;margin-bottom:1rem;border:1px solid rgba(100,181,246,0.3)">';
                                html += `<h4 style="margin-top:0;color:#64B5F6">üèÜ Puntos de Ranking (Mesa Final - Top 9)</h4>`;
                                html += `<p style="color:#fff"><strong>Total puntos a repartir:</strong> <span style="font-size:1.2rem;color:#FFD700;font-weight:bold">${j.boxPoints || 0} pts</span></p>`;
                                html += '<table style="width:100%;border-collapse:collapse;margin-top:0.5rem">';
                                html += '<tr style="background:rgba(100,181,246,0.3);color:#fff"><th style="padding:0.5rem;text-align:left">Pos</th><th style="padding:0.5rem;text-align:right">%</th><th style="padding:0.5rem;text-align:right">Puntos</th><th style="padding:0.5rem;text-align:left">Jugador</th></tr>';
                                const parts = j.participants || [];
                                
                                // Create a map of position -> user_id from existing positions
                                const positionMap = {};
                                const hasExplicitPositions = parts.some(p => p.position);
                                
                                if (hasExplicitPositions) {
                                    // Usar posiciones expl√≠citas guardadas
                                    parts.forEach(p => {
                                        if (p.position) positionMap[p.position] = p.user_id;
                                    });
                                } else {
                                    // Auto-asignar por orden de registro (primero registrado = 1¬∞, segundo = 2¬∞, etc.)
                                    const sortedByRegistration = parts.slice().sort((a, b) => {
                                        const dateA = new Date(a.registration_date || 0);
                                        const dateB = new Date(b.registration_date || 0);
                                        return dateA - dateB;
                                    });
                                    sortedByRegistration.forEach((p, idx) => {
                                        positionMap[idx + 1] = p.user_id;
                                    });
                                }
                                
                                (j.rankingPointsDistribution || []).forEach(rp => {
                                    const preselectedUser = positionMap[rp.position] || "";
                                    html += `<tr style="border-bottom:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.02)">`;
                                    html += `<td style="padding:0.5rem;color:#FFD700"><strong>${rp.position}¬∫</strong></td>`;
                                    html += `<td style="padding:0.5rem;text-align:right;color:#ddd">${rp.percentage}%</td>`;
                                    html += `<td style="padding:0.5rem;text-align:right;color:#64B5F6"><strong>${rp.points}</strong></td>`;
                                    html += `<td style="padding:0.5rem"><select class="rankingUser" data-pos="${rp.position}" style="width:100%;padding:0.25rem;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;border-radius:4px"><option value="">-- asignar jugador --</option>`;
                                    parts.forEach(u => { 
                                        const selected = (u.user_id == preselectedUser) ? " selected" : "";
                                        html += `<option value="${u.user_id}"${selected}>${u.username}${u.full_name ? " (" + u.full_name + ")" : ""}</option>`; 
                                    });
                                    html += `</select></td></tr>`;
                                });
                                html += '</table>';
                                html += '</div>';

                                // Prizes section
                                html += '<div style="background:rgba(76,175,80,0.1);padding:1rem;border-radius:6px;margin-bottom:1rem;border:1px solid rgba(76,175,80,0.3)">';
                                html += '<h4 style="margin-top:0;color:#4CAF50">üíµ Premios en Efectivo (Top 20)</h4>';
                                html += '<div style="max-height:300px;overflow-y:auto">';
                                html += '<table style="width:100%;border-collapse:collapse">';
                                html += '<tr style="background:rgba(76,175,80,0.3);color:#fff"><th style="padding:0.5rem;text-align:left">Pos</th><th style="padding:0.5rem;text-align:right">%</th><th style="padding:0.5rem;text-align:right">Monto ($)</th><th style="padding:0.5rem;text-align:left">Jugador</th></tr>';
                                
                                // Reusar el mismo positionMap creado anteriormente para premios
                                (j.defaultPrizes||[]).forEach(p => {
                                    const preselectedUser = positionMap[p.position] || "";
                                    html += `<tr style="border-bottom:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.02)">`;
                                    html += `<td style="padding:0.5rem;color:#FFD700"><strong>${p.position}¬∫</strong></td>`;
                                    html += `<td style="padding:0.5rem;text-align:right;color:#ddd">${p.percentage}%</td>`;
                                    html += `<td style="padding:0.5rem;text-align:right"><input class="prizeAmt" data-pos="${p.position}" value="${Math.round(p.amount||0)}" style="width:6rem;padding:0.25rem;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;border-radius:4px;text-align:right"></td>`;
                                    html += `<td style="padding:0.5rem"><select class="prizeUser" data-pos="${p.position}" style="width:100%;padding:0.25rem;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;border-radius:4px"><option value="">-- asignar jugador --</option>`;
                                    parts.forEach(u => { 
                                        const selected = (u.user_id == preselectedUser) ? " selected" : "";
                                        html += `<option value="${u.user_id}"${selected}>${u.username}${u.full_name ? " (" + u.full_name + ")" : ""}</option>`; 
                                    });
                                    html += `</select></td></tr>`;
                                });
                                html += '</table>';
                                html += '</div>';
                                html += '<div id="prizeTotals" style="margin-top:0.5rem;padding:0.5rem;background:rgba(255,255,255,0.05);border-radius:4px;color:#fff;border:1px solid rgba(255,255,255,0.1)"></div>';
                                html += '</div>';

                                html += '</div>';
                                if (finalizeBody) finalizeBody.innerHTML = html;
                            } catch (e) {
                                console.error('Error rendering finalize preview:', e);
                                if (finalizeBody) finalizeBody.innerHTML = '<p>Error cargando previsualizaci√≥n</p>';
                            }
                        }

                        // Handler for CLOSE REGISTRATIONS button
                        if (openCloseRegistrationsBtn) {
                            console.log('Adding click handler to close registrations button');
                            openCloseRegistrationsBtn.addEventListener('click', async function() {
                                console.log('Close registrations button clicked!');
                                if (!registrationsModal || !registrationsBody) {
                                    console.error('Modal or body not found:', { registrationsModal: registrationsModal, registrationsBody: registrationsBody });
                                    return;
                                }
                                console.log('Opening modal...');
                                registrationsModal.style.display = 'flex';
                                registrationsBody.innerHTML = '<p>Cargando datos del torneo...</p>';
                                try {
                                    console.log('Fetching preview data...');
                                    const res = await fetch('/admin/games/tournaments/' + tid + '/preview-close');
                                    const j = await res.json();
                                    console.log('Preview data received:', j);
                                    renderRegistrationsPreview(j);
                                } catch (e) {
                                    console.error('Error loading preview:', e);
                                    registrationsBody.innerHTML = '<p>Error cargando informaci√≥n</p>';
                                }
                            });
                        } else {
                            console.warn('openCloseRegistrationsBtn not found!');
                        }

                        // Handler for FINALIZE TOURNAMENT button
                        if (openFinalizeBtn) {
                            openFinalizeBtn.addEventListener('click', async () => {
                                if (!finalizeModal || !finalizeBody) return;
                                finalizeModal.style.display = 'flex';
                                finalizeBody.innerHTML = 'Cargando...';
                                try {
                                    const res = await fetch(`/admin/games/tournaments/${tid}/preview-close`);
                                    const j = await res.json();
                                    renderFinalizePreview(j);

                                    // wire recalc and assign handlers after rendering
                                    const prizePoolSpan = finalizeBody.querySelector('#modalPrizePool');
                                    const pot = Number((j && j.pot) || 0);
                                    const commissionPct = 20; // Fijo: 18% casa + 1% temporada + 1% anual

                                    function recalcTotals() {
                                        const commissionAmt = Math.round(pot * (commissionPct / 100));
                                        const prizePool = pot - commissionAmt;
                                        if (prizePoolSpan) prizePoolSpan.textContent = Math.round(prizePool);
                                        const prizeAmtEls = Array.from(finalizeBody.querySelectorAll('.prizeAmt'));
                                        let totalPrizes = 0;
                                        prizeAmtEls.forEach(e => { totalPrizes += Math.round(Number(e.value) || 0); });
                                        const totalsEl = finalizeBody.querySelector('#prizeTotals');
                                        if (totalsEl) totalsEl.textContent = `Suma premios: $${totalPrizes} ‚Äî Pozo disponible: $${Math.round(prizePool)}`;
                                        const over = totalPrizes > prizePool + 1;
                                        if (over) {
                                            if (totalsEl) totalsEl.style.color = '#900';
                                            if (confirmFinalizeBtn) confirmFinalizeBtn.disabled = true;
                                        } else {
                                            if (totalsEl) totalsEl.style.color = '';
                                            if (confirmFinalizeBtn) confirmFinalizeBtn.disabled = false;
                                        }
                                    }

                                    Array.from(finalizeBody.querySelectorAll('.prizeAmt')).forEach(e => e.addEventListener('input', recalcTotals));
                                    recalcTotals();

                                } catch (e) {
                                    console.error('Error loading finalize preview:', e);
                                    finalizeBody.innerHTML = '<p>Error cargando informaci√≥n</p>';
                                }
                            });
                        }

                        // Cancel buttons
                        if (cancelRegistrationsBtn) cancelRegistrationsBtn.addEventListener('click', () => { 
                            if (registrationsModal) registrationsModal.style.display = 'none'; 
                        });
                        
                        if (cancelFinalizeBtn) cancelFinalizeBtn.addEventListener('click', () => { 
                            if (finalizeModal) finalizeModal.style.display = 'none'; 
                        });

                        // Confirm close registrations (POST and close modal)
                        if (confirmCloseRegistrationsBtn) confirmCloseRegistrationsBtn.addEventListener('click', async () => {
                            try {
                                const res = await fetch(`/admin/games/tournaments/${tid}/close-registrations`, { method: 'POST' });
                                if (res.ok) {
                                    window.location.reload();
                                } else {
                                    alert('Error cerrando inscripciones');
                                }
                            } catch (e) {
                                console.error('Error closing registrations:', e);
                                alert('Error cerrando inscripciones');
                            }
                        });

                        // Confirm finalize tournament
                        if (confirmFinalizeBtn) confirmFinalizeBtn.addEventListener('click', async () => {
                            if (!finalizeBody) return;
                            // Comisiones fijas: 18% casa + 1% temporada + 1% anual = 20% total
                            const commissionPct = 20;
                            
                            // Collect prizes
                            const prizes = [];
                            const prizeAmtEls = finalizeBody.querySelectorAll('.prizeAmt');
                            const prizeUserEls = finalizeBody.querySelectorAll('.prizeUser');
                            for (let i=0;i<prizeAmtEls.length;i++) {
                                const amt = Number(prizeAmtEls[i].value) || 0;
                                const pos = Number(prizeAmtEls[i].getAttribute('data-pos'));
                                const userSel = prizeUserEls[i];
                                const userId = userSel ? Number(userSel.value) : null;
                                if (amt > 0 && userId) {
                                    prizes.push({ position: pos, user_id: userId, amount: amt });
                                }
                            }
                            
                            // Collect ranking positions
                            const positions = [];
                            const rankingUserEls = finalizeBody.querySelectorAll('.rankingUser');
                            rankingUserEls.forEach(sel => {
                                const pos = Number(sel.getAttribute('data-pos'));
                                const userId = Number(sel.value);
                                if (userId) {
                                    positions.push({ position: pos, user_id: userId });
                                }
                            });
                            
                            if (confirmFinalizeBtn) confirmFinalizeBtn.disabled = true;
                            try {
                                const res = await fetch(`/admin/games/tournaments/${tid}/confirm-close`, { 
                                    method: 'POST', 
                                    headers: { 'Content-Type': 'application/json' }, 
                                    body: JSON.stringify({ commissionPct, prizes, positions }) 
                                });
                                const j = await res.json();
                                if (j.ok) {
                                    if (finalizeBody) finalizeBody.innerHTML = `<p style="color:#2e7d32;font-size:1.1rem">‚úì Cierre completado exitosamente</p><p>Pozo: $${Math.round(j.pot)}<br>Comisi√≥n: $${Math.round(j.commissionAmount)}<br>Premios: $${Math.round(j.prizePool)}</p><p style="margin-top:1rem">Redirigiendo...</p>`;
                                    setTimeout(() => { window.location.href = `/admin/games/tournaments/${tid}`; }, 1500);
                                } else {
                                    if (finalizeBody) finalizeBody.innerHTML = `<p style="color:#c62828">Error: ${j.error || "Error al cerrar torneo"}</p>`;
                                }
                            } catch (e) {
                                console.error('Error confirming close:', e);
                                if (finalizeBody) finalizeBody.innerHTML = '<p style="color:#c62828">Error al confirmar cierre</p>';
                            } finally { if (confirmFinalizeBtn) confirmFinalizeBtn.disabled = false; }
                        });

                        })();
                    })();
                });
                </script>
                <script src="/js/quickpay-modal.js"></script>
                <script>
                    // compute dynamic offset for sticky table header so it never overlaps tournament attributes
                    (function(){
                        function setHeaderOffset(){
                            try{
                                const siteHeader = document.querySelector('.pa-header');
                                const detail = document.querySelector('.tournament-detail-container');
                                const headerH = siteHeader ? siteHeader.getBoundingClientRect().height : 0;
                                const detailRect = detail ? detail.getBoundingClientRect() : { bottom: headerH };
                                // compute top: when detail is visible below the site header, use its bottom; otherwise use site header height
                                const top = Math.max(headerH, Math.round(detailRect.bottom));
                                document.documentElement.style.setProperty('--tournament-info-height', top + 'px');
                            }catch(e){/* ignore */}
                        }
                        // update on load/resize/scroll and shortly after init to catch font/image shifts
                        window.addEventListener('load', setHeaderOffset);
                        window.addEventListener('resize', setHeaderOffset);
                        window.addEventListener('scroll', setHeaderOffset, { passive: true });
                        setTimeout(setHeaderOffset, 300);
                    })();
                </script>
</div>

    {{!-- Desglose visible para todos cuando inscripciones est√°n cerradas --}}
    {{#unless tournament.registration_open}}
    <div id="tournamentBreakdown" style="background:linear-gradient(135deg, rgba(76, 175, 80, 0.08), rgba(33, 150, 243, 0.08));border:2px solid rgba(76, 175, 80, 0.3);border-radius:12px;padding:1.5rem;margin-bottom:2rem;">
        <h2 style="color:#4CAF50;margin-top:0;display:flex;align-items:center;gap:0.5rem;">
            <svg style="width:28px;height:28px;" viewBox="0 0 24 24" fill="#4CAF50"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/><path d="M12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
            üí∞ Informaci√≥n del Torneo (Inscripciones Cerradas)
        </h2>
        <div id="breakdownContent">
            <p style="color:#ddd;margin-bottom:1rem;font-size:0.95rem;">‚è≥ Cargando informaci√≥n...</p>
        </div>
    </div>
    <script>
        // Cargar y mostrar informaci√≥n del torneo
        (async function(){
            try {
                const res = await fetch('/admin/games/tournaments/{{tournament.id}}/preview-close');
                const data = await res.json();
                const content = document.getElementById('breakdownContent');
                if (!content) return;

                let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-bottom:1.5rem;">';
                
                // Card: Pozo total
                html += '<div style="background:rgba(76,175,80,0.15);border:2px solid rgba(76,175,80,0.4);border-radius:8px;padding:1.25rem;text-align:center;">';
                html += '<div style="font-size:0.9rem;color:#aaa;margin-bottom:0.5rem;">üíµ Pozo Total</div>';
                html += `<div style="font-size:2rem;font-weight:700;color:#4CAF50;">\\$${data.pot.toLocaleString()}</div>`;
                html += `<div style="font-size:0.85rem;color:#999;margin-top:0.5rem;">${data.totalBoxes} cajas</div>`;
                html += '</div>';
                
                // Card: Comisi√≥n
                html += '<div style="background:rgba(255,152,0,0.15);border:2px solid rgba(255,152,0,0.4);border-radius:8px;padding:1.25rem;text-align:center;">';
                html += '<div style="font-size:0.9rem;color:#aaa;margin-bottom:0.5rem;">üíº Comisi√≥n (20%)</div>';
                html += `<div style="font-size:2rem;font-weight:700;color:#FF9800;">\\$${data.commissionAmount.toLocaleString()}</div>`;
                html += '<div style="font-size:0.75rem;color:#999;margin-top:0.5rem;">';
                html += `Casa: \\$${data.commissionHouse.toLocaleString()}<br>`;
                html += `Temp: \\$${data.commissionSeason.toLocaleString()} | Anual: \\$${data.commissionAnnual.toLocaleString()}`;
                html += '</div></div>';
                
                // Card: Premios
                html += '<div style="background:rgba(255,215,0,0.15);border:2px solid rgba(255,215,0,0.4);border-radius:8px;padding:1.25rem;text-align:center;">';
                html += '<div style="font-size:0.9rem;color:#aaa;margin-bottom:0.5rem;">üèÜ Premios</div>';
                html += `<div style="font-size:2rem;font-weight:700;color:#FFD700;">\\$${data.prizePool.toLocaleString()}</div>`;
                html += '<div style="font-size:0.85rem;color:#999;margin-top:0.5rem;">A repartir (Top 20)</div>';
                html += '</div>';
                
                // Card: Puntos
                html += '<div style="background:rgba(33,150,243,0.15);border:2px solid rgba(33,150,243,0.4);border-radius:8px;padding:1.25rem;text-align:center;">';
                html += '<div style="font-size:0.9rem;color:#aaa;margin-bottom:0.5rem;">‚≠ê Puntos</div>';
                html += `<div style="font-size:2rem;font-weight:700;color:#2196F3;">${data.boxPoints.toLocaleString()}</div>`;
                html += '<div style="font-size:0.85rem;color:#999;margin-top:0.5rem;">Mesa final (Top 9)</div>';
                html += '</div>';
                
                html += '</div>';

                // Tabla detallada
                html += '<details style="background:rgba(255,255,255,0.03);padding:1rem;border-radius:8px;border:1px solid rgba(255,255,255,0.1);">';
                html += '<summary style="cursor:pointer;font-weight:600;color:#FFD700;padding:0.5rem;margin-bottom:1rem;">üìä Ver distribuci√≥n detallada</summary>';
                html += '<div style="overflow-x:auto;">';
                html += '<table style="width:100%;border-collapse:collapse;margin-top:1rem;">';
                html += '<thead><tr style="background:rgba(255,255,255,0.05);">';
                html += '<th style="padding:0.75rem;text-align:left;color:#FFD700;border-bottom:2px solid rgba(255,215,0,0.3);">Pos</th>';
                html += '<th style="padding:0.75rem;text-align:right;color:#FFD700;border-bottom:2px solid rgba(255,215,0,0.3);">Premio ($)</th>';
                html += '<th style="padding:0.75rem;text-align:right;color:#2196F3;border-bottom:2px solid rgba(33,150,243,0.3);">Puntos</th>';
                html += '<th style="padding:0.75rem;text-align:center;color:#999;border-bottom:2px solid rgba(255,255,255,0.1);">%</th>';
                html += '</tr></thead><tbody>';

                const maxPos = Math.min(20, data.defaultPrizes.length);
                for (let i = 0; i < maxPos; i++) {
                    const prize = data.defaultPrizes[i];
                    const points = data.rankingPointsDistribution[i];
                    
                    if (prize && (prize.amount > 0 || (points && points.points > 0))) {
                        const pos = i + 1;
                        const medal = pos === 1 ? 'ü•á' : pos === 2 ? 'ü•à' : pos === 3 ? 'ü•â' : `${pos}¬∫`;
                        html += `<tr style="border-bottom:1px solid rgba(255,255,255,0.05);">`;
                        html += `<td style="padding:0.75rem;color:#ddd;font-weight:600;">${medal}</td>`;
                        html += `<td style="padding:0.75rem;text-align:right;color:#FFD700;font-weight:600;">$${Math.round(prize.amount)} <span style="color:#999;font-size:0.85rem;">(${prize.percentage}%)</span></td>`;
                        html += `<td style="padding:0.75rem;text-align:right;color:#2196F3;font-weight:600;">${points ? points.points : 0} <span style="color:#999;font-size:0.85rem;">${points ? '(' + points.percentage + '%)' : ''}</span></td>`;
                        html += `<td style="padding:0.75rem;text-align:center;color:#999;font-size:0.9rem;">${prize.percentage}%</td>`;
                        html += '</tr>';
                    }
                }

                html += '</tbody></table></div></details>';

                content.innerHTML = html;
            } catch (err) {
                console.error('Error cargando desglose:', err);
                const content = document.getElementById('breakdownContent');
                if (content) {
                    content.innerHTML = '<p style="color:#f44336;">‚ùå Error al cargar informaci√≥n</p>';
                }
            }
        })();
    </script>
    {{/unless}}

    {{!-- Inline registration form for admins --}}
    {{#isAdmin role}}
    <div class="tournament-registrations">
        <h2>üìù Registrar jugador en torneo</h2>
        <form method="post" action="/admin/games/tournaments/{{tournament.id}}/register" id="tournamentRegForm" style="background:rgba(255,255,255,0.03);padding:1.5rem;border-radius:12px;border:1px solid rgba(255,255,255,0.1);">
            
            {{!-- Secci√≥n 1: Buscar o crear jugador --}}
            <div style="margin-bottom:1.5rem;padding-bottom:1.5rem;border-bottom:1px solid rgba(255,255,255,0.1);">
                <h3 style="color:#FFD700;margin-top:0;">üë§ Seleccionar Jugador</h3>
                <label for="user_search_input" style="font-weight:600;color:#dfe6ff;">Usuario (buscar):</label>
                <input list="user_search_list" id="user_search_input" name="user_search_input" placeholder="Escribe username o nombre..." autocomplete="off" style="width:100%;padding:0.75rem;background:rgba(255,255,255,0.05);border:2px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;margin-bottom:0.5rem;" required />
                <datalist id="user_search_list"></datalist>
                <input type="hidden" id="user_id" name="user_id" value="" />
                
                <details style="margin-top:0.75rem;">
                    <summary style="cursor:pointer;color:#FFD700;font-weight:600;">+ Crear usuario nuevo</summary>
                    <div style="margin-top:0.75rem;padding:0.75rem;background:rgba(255,215,0,0.05);border-radius:8px;">
                        <label for="new_user_username" style="font-weight:600;color:#dfe6ff;">Username:</label>
                        <input id="new_user_username" name="new_user_username" placeholder="nuevo_username" style="width:100%;padding:0.5rem;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:4px;color:#fff;margin-bottom:0.5rem;">
                        <label for="new_user_full_name" style="font-weight:600;color:#dfe6ff;">Nombre completo (opcional):</label>
                        <input id="new_user_full_name" name="new_user_full_name" placeholder="Nombre Apellido" style="width:100%;padding:0.5rem;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:4px;color:#fff;margin-bottom:0.5rem;">
                        <button type="button" id="quick_create_user_btn" style="padding:0.5rem 1rem;background:#4CAF50;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;">‚úì Crear y seleccionar</button>
                    </div>
                </details>
            </div>

            {{!-- Secci√≥n 2: Tipo de acci√≥n DESPU√âS de nombres --}}
            <div style="margin-bottom:1.5rem;padding-bottom:1.5rem;border-bottom:1px solid rgba(255,255,255,0.1);">
                <h3 style="color:#FFD700;margin-top:0;">üéØ Tipo de Inscripci√≥n</h3>
                <label for="action_type" style="font-weight:600;color:#dfe6ff;">Acci√≥n:</label>
                <select id="action_type" name="action_type" required style="width:100%;padding:0.75rem;background:rgba(255,255,255,0.05);border:2px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;font-size:1rem;">
                    <option value="1">üí∞ Buy-in (Entrada inicial)</option>
                    <option value="2">üîÑ Re-entry (Reentrada)</option>
                    <option value="3">‚ú® Duplo (Doble)</option>
                </select>
                <small style="color:rgba(255,255,255,0.6);font-size:0.85rem;display:block;margin-top:0.5rem;">
                    ‚ÑπÔ∏è Solo puede haber UN buy-in por jugador en este torneo
                </small>
            </div>

            {{!-- Secci√≥n 3: Pago --}}
            <div style="margin-bottom:1.5rem;">
                <h3 style="color:#FFD700;margin-top:0;">üíµ Informaci√≥n de Pago</h3>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                    <div>
                        <label for="amount_paid" style="font-weight:600;color:#dfe6ff;">Monto pagado ahora (vac√≠o = FIADO):</label>
                        <input type="number" id="amount_paid" name="amount_paid" step="0.01" min="0" placeholder="Dejar vac√≠o si es fiado" style="width:100%;padding:0.75rem;background:rgba(255,255,255,0.05);border:2px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;">
                    </div>
                    <div>
                        <label for="method" style="font-weight:600;color:#dfe6ff;">M√©todo de pago:</label>
                        <select id="method" name="method" style="width:100%;padding:0.75rem;background:rgba(255,255,255,0.05);border:2px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;">
                            <option value="">üîñ No paga (FIADO)</option>
                            <option value="cash" selected>üíµ Efectivo</option>
                            <option value="transfer">üè¶ Transferencia</option>
                            <option value="card">üí≥ Tarjeta</option>
                            <option value="other">üìù Otro</option>
                        </select>
                    </div>
                </div>
            </div>

            <button type="submit" style="width:100%;padding:1rem;background:linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(76, 175, 80, 0.1));border:2px solid #4CAF50;border-radius:10px;color:#4CAF50;font-size:1.1rem;font-weight:700;cursor:pointer;">‚úîÔ∏è Registrar Inscripci√≥n</button>
        </form>
        <script src="/js/user-autocomplete.js"></script>
        <script src="/js/typeahead-quickcreate.js"></script>
        <script>
            // attach typeahead for tournament registration (fallbacks to old autocomplete if needed)
            (function(){
                if (window.TypeaheadQuickCreate) {
                    window.TypeaheadQuickCreate.attach({ 
                        inputSelector: '#user_search_input', 
                        hiddenSelector: '#user_id',
                        onNoResults: (query) => {
                            // Cuando no hay resultados al presionar Enter, abrir modal
                            if (confirm(`No se encontr√≥ "${query}".\n\n¬øDeseas crear este usuario?`)) {
                                window.TypeaheadQuickCreate.openQuickCreate({ 
                                    inputSelector: '#user_search_input', 
                                    hiddenSelector: '#user_id',
                                    prefillUsername: query
                                });
                            }
                        }
                    });
                } else if (window.UserAutocomplete) {
                    window.UserAutocomplete.attach({ inputSelector: '#user_search_input', hiddenSelector: '#user_id', datalistSelector: '#user_search_list' });
                }

                // wire quick create button to create inline (NO modal)
                const btn = document.getElementById('quick_create_user_btn');
                if (btn && window.TypeaheadQuickCreate) {
                    btn.addEventListener('click', async () => {
                        const u = document.getElementById('new_user_username');
                        const f = document.getElementById('new_user_full_name');
                        const uval = u && u.value ? u.value.trim() : '';
                        const fval = f && f.value ? f.value.trim() : '';
                        
                        if (!uval) {
                            alert('‚ö†Ô∏è Ingresa un username v√°lido');
                            return;
                        }

                        try {
                            const res = await fetch('/admin/users/quick-create', { 
                                method: 'POST', 
                                headers: { 'Content-Type': 'application/json' }, 
                                body: JSON.stringify({ username: uval, full_name: fval }) 
                            });
                            const created = await res.json();
                            
                            if (!res.ok) {
                                alert('‚ùå Error: ' + (created.error || 'No se pudo crear el usuario'));
                                return;
                            }

                            // Seleccionar el usuario creado
                            const hid = document.getElementById('user_id');
                            const input = document.getElementById('user_search_input');
                            if (hid) hid.value = created.id;
                            if (input) input.value = `${created.username}${created.full_name ? ' - ' + created.full_name : ''}`;
                            
                            // Limpiar campos
                            if (u) u.value = '';
                            if (f) f.value = '';

                            // Cerrar el details expandible
                            const details = btn.closest('details');
                            if (details) details.open = false;
                            
                            // Mostrar contrase√±a temporal
                            if (created.tempPassword) {
                                alert(`‚úÖ Usuario creado exitosamente!\n\n` +
                                      `üë§ Username: ${created.username}\n` +
                                      `üîë Contrase√±a temporal: ${created.tempPassword}\n\n` +
                                      `‚ö†Ô∏è IMPORTANTE: Guarda esta contrase√±a, el usuario la necesitar√° para iniciar sesi√≥n.`);
                            } else {
                                alert('‚úÖ Usuario creado y seleccionado');
                            }
                        } catch (err) {
                            alert('‚ùå Error de red al crear usuario');
                            console.error(err);
                        }
                    });
                } else if (btn && window.UserAutocomplete) {
                    // legacy fallback: inline quick-create
                    btn.addEventListener('click', async () => {
                        const u = document.getElementById('new_user_username');
                        const f = document.getElementById('new_user_full_name');
                        const uval = u && u.value ? u.value : '';
                        const fval = f && f.value ? f.value : '';
                        if (!uval) return alert('Ingrese un username v√°lido');
                        try {
                            const created = await window.UserAutocomplete.createUser(uval.trim(), fval.trim());
                            const hid = document.getElementById('user_id');
                            const input = document.getElementById('user_search_input');
                            if (hid) hid.value = created.id;
                            if (input) input.value = `${created.username}${created.full_name ? " - " + created.full_name : ""}`;
                            if (u) u.value = '';
                            if (f) f.value = '';
                            
                            // Mostrar contrase√±a temporal generada
                            if (created.tempPassword) {
                                alert(`‚úÖ Usuario creado exitosamente!\n\n` +
                                      `üë§ Username: ${created.username}\n` +
                                      `üîë Contrase√±a temporal: ${created.tempPassword}\n\n` +
                                      `‚ö†Ô∏è IMPORTANTE: Guarda esta contrase√±a, el usuario la necesitar√° para iniciar sesi√≥n.`);
                            } else {
                                alert('Usuario creado y seleccionado');
                            }
                        } catch (err) {
                            alert('Error creando usuario: ' + (err && err.error ? err.error : err));
                        }
                    });
                }

                // Validaci√≥n de buy-in duplicado antes del submit + guardar scroll
                const form = document.getElementById('tournamentRegForm');
                const actionTypeSelect = document.getElementById('action_type');
                const userIdInput = document.getElementById('user_id');

                if (form) {
                    form.addEventListener('submit', async (e) => {
                        const actionType = actionTypeSelect ? actionTypeSelect.value : '';
                        const userId = userIdInput ? userIdInput.value : '';

                        // Guardar posici√≥n del scroll antes de enviar
                        sessionStorage.setItem('tournamentScrollPos', window.scrollY.toString());

                        // Validar si es Buy-in (action_type = 1)
                        if (actionType === '1' && userId) {
                            e.preventDefault(); // Solo prevenir si necesitamos validar
                            
                            try {
                                const response = await fetch(`/admin/registrations/check-buyin?tournament_id={{tournament.id}}&user_id=${userId}`);
                                const data = await response.json();
                                
                                if (data.exists) {
                                    alert('‚ö†Ô∏è Este jugador ya tiene un Buy-in registrado en este torneo.\n\nSolo puede haber UN buy-in por jugador. Si quieres agregar una reentrada, selecciona "Re-entry" en el tipo de acci√≥n.');
                                    sessionStorage.removeItem('tournamentScrollPos'); // Limpiar si hay error
                                    return;
                                }
                                
                                // Si no existe, enviar el formulario normalmente
                                form.submit();
                            } catch (err) {
                                console.error('Error validando buy-in:', err);
                                // Si hay error en la validaci√≥n, permitir el submit de todas formas
                                form.submit();
                            }
                        }
                        // Si no es buy-in, dejar que el formulario se env√≠e normalmente (no preventDefault)
                    });
                }

                // Restaurar posici√≥n del scroll despu√©s de la recarga
                const savedScroll = sessionStorage.getItem('tournamentScrollPos');
                if (savedScroll) {
                    setTimeout(() => {
                        window.scrollTo(0, parseInt(savedScroll));
                        sessionStorage.removeItem('tournamentScrollPos');
                    }, 100);
                }
            })();
        </script>

                <h3>Participantes</h3>
                <div class="registrations-controls">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; margin-bottom: 1rem;">
                        <div>
                            <label for="registrationsFilter" style="margin-right:0.5rem; font-weight:600; color:#ffd884">Buscar:</label>
                            <input id="registrationsFilter" placeholder="Nombre o usuario..." style="padding:6px 10px; border-radius:6px; border:1px solid rgba(255, 215, 0, 0.3); background: var(--input-bg); color: var(--input-color); width:200px" />
                        </div>
                        <div>
                            <label for="actionFilter" style="margin-right:0.5rem; font-weight:600; color:#ffd884">Acci√≥n:</label>
                            <select id="actionFilter" style="padding:6px 10px; border-radius:6px; border:1px solid rgba(255, 215, 0, 0.3); background: var(--input-bg); color: var(--input-color);">
                                <option value="">Todas</option>
                                <option value="Buy-in">Buy-in</option>
                                <option value="Re-entry">Re-entry</option>
                                <option value="Duplo">Duplo</option>
                            </select>
                        </div>
                        <div>
                            <label for="paymentFilter" style="margin-right:0.5rem; font-weight:600; color:#ffd884">Pago:</label>
                            <select id="paymentFilter" style="padding:6px 10px; border-radius:6px; border:1px solid rgba(255, 215, 0, 0.3); background: var(--input-bg); color: var(--input-color);">
                                <option value="">Todos</option>
                                <option value="paid">Pagados</option>
                                <option value="unpaid">Sin pagar</option>
                                <option value="partial">Pago parcial</option>
                            </select>
                        </div>
                        <button id="clearFilters" class="btn" style="padding:6px 16px; font-size:0.9rem; margin-left:auto;">Limpiar filtros</button>
                    </div>
                </div>
                <div class="table-responsive">
                <table class="registrations-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Nombre</th>
                                        <th>Acci√≥n</th>
                                        <th>Puntualidad</th>
                                        <th>Hora</th>
                                        <th>Pag√≥</th>
                                        <th>M√©todo</th>
                                        <th>Pago Parcial</th>
                                        <th>Cta. Personal</th>
                                        <th>Deuda</th>
                                        <th>Al Pozo</th>
                                        <th>Acciones</th>
                                        <th>Posici√≥n</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- client populated -->
                                </tbody>
                        </table>
                </div>
                
                <div style="margin-top:0.8rem; padding:0.75rem; background:rgba(76,175,80,0.1); border:1px solid rgba(76,175,80,0.3); border-radius:6px;">
                    <p style="margin:0; color:#4caf50; font-weight:600;">
                        ‚ÑπÔ∏è Las posiciones se guardan autom√°ticamente al escribir
                        <span id="savePositionsMsg" style="margin-left:1rem; font-weight:normal; color:#dfe6ff;"></span>
                    </p>
                </div>
                        <script>
                            (function(){
                                const tid = {{tournament.id}};
                                async function loadParticipants(){
                                    try {
                                        const res = await fetch(`/admin/games/tournaments/${tid}/participants-json`);
                                        if (!res.ok) throw new Error('fetch failed');
                                        const j = await res.json();
                                        const parts = j.participants || [];
                                        const tbody = document.querySelector('.registrations-table tbody');
                                        if (!tbody) return;
                                        tbody.innerHTML = '';
                                        parts.forEach((p, idx) => {
                                            const tr = document.createElement('tr');
                                            const name = p.full_name ? (`<span class="participant-username">${p.username}</span> <span class="participant-full"> - ${p.full_name}</span>`) : `<span class="participant-username">${p.username}</span>`;
                                            const isPaid = (p.paid && p.paid > 0);
                                            const isPartialPaid = isPaid && p.paid < p.expected;
                                            const paidLabel = isPaid ? "‚úì" : "‚úó";
                                            const partial = isPartialPaid ? `$${p.paid.toFixed(2)}` : "";
                                            const paidClass = isPaid ? "text-success" : "text-danger";
                                            const punctualityLabel = p.punctuality ? "‚úì" : "‚úó";
                                            const punctualityClass = p.punctuality ? "text-success" : "text-danger";
                                            
                                            // Extraer m√©todo de pago (antes del |by:)
                                            let methodLabel = "";
                                            if (p.lastMethod) {
                                                const methodStr = String(p.lastMethod).trim();
                                                const match = methodStr.match(/\|by:/i);
                                                const method = match ? methodStr.substring(0, match.index).trim() : methodStr;
                                                const methodLower = method.toLowerCase();
                                                
                                                const methodMap = {
                                                    'cash': 'üíµ Efectivo',
                                                    'efectivo': 'üíµ Efectivo',
                                                    'transfer': 'üè¶ Transferencia',
                                                    'transferencia': 'üè¶ Transferencia',
                                                    'card': 'üí≥ Tarjeta',
                                                    'tarjeta': 'üí≥ Tarjeta',
                                                    'credit': 'üí≥ Tarjeta',
                                                    'debit': 'üí≥ D√©bito',
                                                    'manual': 'üìù Manual',
                                                    'other': 'üìù Otro',
                                                    'fiado': 'üîñ FIADO'
                                                };
                                                
                                                methodLabel = methodMap[methodLower] || `üìù ${method}`;
                                            }
                                            
                                            // Determinar estado de pago para filtro
                                            let paymentStatus = 'unpaid';
                                            if (isPaid) {
                                                paymentStatus = isPartialPaid ? 'partial' : 'paid';
                                            }
                                            
                                            tr.setAttribute('data-action', p.action || '');
                                            tr.setAttribute('data-payment-status', paymentStatus);
                                            tr.setAttribute('data-search', `${p.username} ${p.full_name || ''}`.toLowerCase());
                                            
                                            tr.innerHTML = `
                                                <td class="col-index">${idx+1}</td>
                                                <td class="col-name">${name}</td>
                                                <td class="col-action">${p.action}</td>
                                                <td class="col-punctuality ${punctualityClass}">${punctualityLabel}</td>
                                                <td class="col-time">${new Date(p.registration_date).toLocaleString('es-AR', { timeZone: 'America/Argentina/Buenos_Aires', dateStyle: 'short', timeStyle: 'short' })}</td>
                                                <td class="col-paid ${paidClass}">${paidLabel}</td>
                                                <td class="col-method">${methodLabel}</td>
                                                <td class="col-partial">${partial}</td>
                                                <td class="col-personal">${p.personal_account ? "‚úì" : ""}</td>
                                                <td class="col-debt">$${(p.debt||0).toFixed(2)}</td>
                                                <td class="col-pot">$${(p.amount_contributed_to_pot||0).toFixed(2)}</td>
                                                <td class="action-column"> 
                                                    <button class="quick-pay-btn" role="button" aria-label="Pagar r√°pido a ${p.username}" data-user-id="${p.user_id}" ${((p.debt||0) <= 0 && !p.personal_account) ? "disabled" : ""}>Pagar r√°pido</button>
                                                    <button class="delete-reg-btn" role="button" aria-label="Eliminar inscripci√≥n de ${p.username}" data-reg-id="${p.registration_id}" style="background:#f44336;margin-left:0.5rem;">üóëÔ∏è</button>
                                                </td>
                                                <td class="col-position"><input type="number" min="1" class="reg-position" data-rid="${p.registration_id}" value="${p.position||""}" placeholder="Pos" style="width:4rem;padding:0.4rem;border-radius:4px;border:1px solid rgba(255,215,0,0.3);background:var(--input-bg);color:var(--input-color)" /></td>
                                            `;
                                            tbody.appendChild(tr);
                                        });
                                            window.REGISTERED_USERS = new Set((parts||[]).map(p => String(p.user_id)));
                                            
                                            // Agregar validaci√≥n y guardado autom√°tico a los inputs de posici√≥n
                                            const positionInputs = document.querySelectorAll('.reg-position');
                                            let saveTimeout = null;
                                            
                                            function validatePositions() {
                                                const inputs = Array.from(document.querySelectorAll('.reg-position'));
                                                const usedPositions = new Map();
                                                let hasDuplicates = false;
                                                
                                                inputs.forEach(input => {
                                                    const val = input.value.trim();
                                                    if (val !== '') {
                                                        const pos = Number(val);
                                                        if (usedPositions.has(pos)) {
                                                            // Posici√≥n duplicada
                                                            input.style.borderColor = '#f44336';
                                                            input.style.backgroundColor = 'rgba(244, 67, 54, 0.1)';
                                                            const otherInput = usedPositions.get(pos);
                                                            otherInput.style.borderColor = '#f44336';
                                                            otherInput.style.backgroundColor = 'rgba(244, 67, 54, 0.1)';
                                                            hasDuplicates = true;
                                                        } else {
                                                            usedPositions.set(pos, input);
                                                            input.style.borderColor = 'rgba(255, 215, 0, 0.3)';
                                                            input.style.backgroundColor = 'var(--input-bg)';
                                                        }
                                                    } else {
                                                        input.style.borderColor = 'rgba(255, 215, 0, 0.3)';
                                                        input.style.backgroundColor = 'var(--input-bg)';
                                                    }
                                                });
                                                
                                                return !hasDuplicates;
                                            }
                                            
                                            async function savePositions() {
                                                if (!validatePositions()) {
                                                    console.warn('No se puede guardar: posiciones duplicadas');
                                                    return;
                                                }
                                                
                                                const inputs = Array.from(document.querySelectorAll('.reg-position'));
                                                const positions = inputs.map(i => ({ 
                                                    registration_id: Number(i.dataset.rid), 
                                                    position: (i.value === '') ? null : Number(i.value) 
                                                }));
                                                
                                                try {
                                                    const res = await fetch(`/admin/games/tournaments/${tid}/positions`, { 
                                                        method: 'POST', 
                                                        headers: { 'Content-Type': 'application/json' }, 
                                                        body: JSON.stringify({ positions }) 
                                                    });
                                                    const j = await res.json();
                                                    if (res.ok && j.ok) {
                                                        console.log('‚úì Posiciones guardadas autom√°ticamente');
                                                    }
                                                } catch (e) {
                                                    console.error('Error guardando posiciones:', e);
                                                }
                                            }
                                            
                                            positionInputs.forEach(input => {
                                                input.addEventListener('input', () => {
                                                    validatePositions();
                                                    
                                                    // Cancelar el guardado anterior si existe
                                                    if (saveTimeout) clearTimeout(saveTimeout);
                                                    
                                                    // Guardar despu√©s de 1 segundo de inactividad
                                                    saveTimeout = setTimeout(() => {
                                                        savePositions();
                                                    }, 1000);
                                                });
                                                
                                                input.addEventListener('blur', () => {
                                                    if (saveTimeout) clearTimeout(saveTimeout);
                                                    savePositions();
                                                });
                                            });
                                            
                                            // Sistema de filtros mejorado
                                            const filterInput = document.getElementById('registrationsFilter');
                                            const actionFilter = document.getElementById('actionFilter');
                                            const paymentFilter = document.getElementById('paymentFilter');
                                            const clearFiltersBtn = document.getElementById('clearFilters');
                                            
                                            function applyFilters() {
                                                const searchTerm = (filterInput && filterInput.value) ? filterInput.value.toLowerCase().trim() : '';
                                                const actionValue = (actionFilter && actionFilter.value) ? actionFilter.value : '';
                                                const paymentValue = (paymentFilter && paymentFilter.value) ? paymentFilter.value : '';
                                                
                                                const rows = Array.from(document.querySelectorAll('table.registrations-table tbody tr'));
                                                let visibleCount = 0;
                                                
                                                rows.forEach((row, idx) => {
                                                    const searchData = row.getAttribute('data-search') || '';
                                                    const action = row.getAttribute('data-action') || '';
                                                    const paymentStatus = row.getAttribute('data-payment-status') || '';
                                                    
                                                    let show = true;
                                                    
                                                    // Filtro de b√∫squeda
                                                    if (searchTerm && searchData.indexOf(searchTerm) === -1) {
                                                        show = false;
                                                    }
                                                    
                                                    // Filtro de acci√≥n
                                                    if (actionValue && action !== actionValue) {
                                                        show = false;
                                                    }
                                                    
                                                    // Filtro de pago
                                                    if (paymentValue && paymentStatus !== paymentValue) {
                                                        show = false;
                                                    }
                                                    
                                                    row.style.display = show ? '' : 'none';
                                                    
                                                    // Actualizar numeraci√≥n
                                                    if (show) {
                                                        visibleCount++;
                                                        const indexCell = row.querySelector('.col-index');
                                                        if (indexCell) indexCell.textContent = visibleCount;
                                                    }
                                                });
                                            }
                                            
                                            if (filterInput) filterInput.addEventListener('input', applyFilters);
                                            if (actionFilter) actionFilter.addEventListener('change', applyFilters);
                                            if (paymentFilter) paymentFilter.addEventListener('change', applyFilters);
                                            
                                            if (clearFiltersBtn) {
                                                clearFiltersBtn.addEventListener('click', () => {
                                                    if (filterInput) filterInput.value = '';
                                                    if (actionFilter) actionFilter.value = '';
                                                    if (paymentFilter) paymentFilter.value = '';
                                                    applyFilters();
                                                });
                                            }
                                            
                                            // Event delegation para botones de eliminar inscripci√≥n
                                            document.querySelector('.registrations-table tbody').addEventListener('click', async (e) => {
                                                if (e.target.classList.contains('delete-reg-btn') || e.target.closest('.delete-reg-btn')) {
                                                    const btn = e.target.classList.contains('delete-reg-btn') ? e.target : e.target.closest('.delete-reg-btn');
                                                    const regId = btn.getAttribute('data-reg-id');
                                                    if (!regId) return;
                                                    
                                                    if (!confirm('¬øEst√°s seguro de eliminar esta inscripci√≥n? Esta acci√≥n no se puede deshacer.')) return;
                                                    
                                                    try {
                                                        const res = await fetch(`/admin/games/tournaments/${tid}/registrations/${regId}`, { method: 'DELETE' });
                                                        if (!res.ok) throw new Error('Error al eliminar');
                                                        await loadParticipants(); // recargar tabla
                                                    } catch (err) {
                                                        console.error(err);
                                                        alert('Error al eliminar la inscripci√≥n');
                                                    }
                                                }
                                            });
                                    } catch (e) { console.error('Error loading participants', e); }
                                }
                                window.loadParticipants = loadParticipants;
                                loadParticipants();
                            })();
                        </script>
                </div>
    </div>
    {{/isAdmin}}
