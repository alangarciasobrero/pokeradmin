<h1>Cash Game #{{cash.id}}</h1>
<p>User ID: {{cash.user_id}}</p>
<p>Amount: ${{cash.amount}}</p>
<p>Date: {{cash.start_datetime}}</p>
<p>Description: {{cash.description}}</p>

{{#if username}}
	<h3>Registro rápido (admin)</h3>
		<form method="post" action="/admin/games/cash/{{cash.id}}/register">
			<div>
				<label for="user_search_input">Usuario (buscar o seleccionar)</label>
				<input list="user_search_list" id="user_search_input" name="user_search_input" placeholder="Escribe username o nombre..." autocomplete="off" />
				<datalist id="user_search_list"></datalist>
				<input type="hidden" id="user_id" name="user_id" value="" />
			</div>
		<div>
			<strong>o crear rápido:</strong>
			<label for="new_user_username">username</label>
			<input type="text" name="new_user_username" id="new_user_username" />
			<label for="new_user_full_name">full name</label>
			<input type="text" name="new_user_full_name" id="new_user_full_name" />
			<button type="button" id="quick_create_user_btn">Crear y seleccionar</button>
		</div>
		<div>
			<label for="seat_number">Número de asiento (opcional)</label>
			<input type="number" name="seat_number" id="seat_number" />
		</div>
		<div>
			<label for="amount_paid">Importe pagado (ej. buy-in)</label>
			<input type="text" name="amount_paid" id="amount_paid" />
			<label for="requested_amount">Pedido (monto solicitado para jugar)</label>
			<input type="text" name="requested_amount" id="requested_amount" placeholder="Opcional - monto que el jugador pide" />
			<label for="method">Método</label>
			<select name="method" id="method">
				<option value="cash">Efectivo</option>
				<option value="card">Tarjeta</option>
				<option value="transfer">Transferencia</option>
			</select>
		</div>
		<div>
			<button type="submit">Registrar jugador</button>
		</div>
	</form>
	<script src="/js/user-autocomplete.js"></script>
	<script src="/js/typeahead-quickcreate.js"></script>
	<script>
		if (window.TypeaheadQuickCreate) {
			window.TypeaheadQuickCreate.attach({ inputSelector: '#user_search_input', hiddenSelector: '#user_id' });
		} else if (window.UserAutocomplete) {
			window.UserAutocomplete.attach({ inputSelector: '#user_search_input', hiddenSelector: '#user_id', datalistSelector: '#user_search_list' });
		}

		// quick create wiring for cash form
		(function(){
			const btn = document.getElementById('quick_create_user_btn');
			if (!btn) return;
			if (window.TypeaheadQuickCreate) {
				btn.addEventListener('click', () => window.TypeaheadQuickCreate.openQuickCreate({ inputSelector: '#user_search_input', hiddenSelector: '#user_id' }));
			} else if (window.UserAutocomplete) {
				btn.addEventListener('click', async () => {
					const u = document.getElementById('new_user_username');
					const f = document.getElementById('new_user_full_name');
					const uval = u && u.value ? u.value : '';
					const fval = f && f.value ? f.value : '';
					if (!uval) return alert('Ingrese un username válido');
					try {
						const created = await window.UserAutocomplete.createUser(uval.trim(), fval.trim());
						const hid = document.getElementById('user_id');
						const input = document.getElementById('user_search_input');
						if (hid) hid.value = created.id;
						if (input) input.value = `${created.username}${created.full_name ? ' - ' + created.full_name : ''}`;
						if (u) u.value = '';
						if (f) f.value = '';
						alert('Usuario creado y seleccionado');
					} catch (err) {
						alert('Error creando usuario: ' + (err && err.error ? err.error : err));
					}
				});
			}
		})();
	</script>
{{/if}}

{{#if username}}
	<div style="margin-top:1rem">
		<a class="btn" href="/admin/games/cash/{{cash.id}}/close">Cerrar mesa</a>
	</div>
{{/if}}

<h3>Participantes</h3>
{{#if participants}}
	<table>
		<thead>
			<tr><th>ID</th><th>Usuario</th><th>Seat</th><th>Joined</th><th>Left</th></tr>
		</thead>
		<tbody>
			{{#each participants}}
				<tr>
					<td>{{this.id}}</td>
					<td>{{#if ../umap.[this.user_id]}}{{../umap.[this.user_id].username}}{{else}}User #{{this.user_id}}{{/if}}</td>
					<td>{{this.seat_number}}</td>
					<td>{{this.joined_at}}</td>
					<td>{{this.left_at}}</td>
				</tr>
			{{/each}}
		</tbody>
	</table>
{{else}}
	<p>No hay participantes aún</p>
{{/if}}
